<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Results in BWC WVB 2024</title>
    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100">
    <div class="container">
        <h1 class="text-3xl font-bold mb-4">Match Results in BWC WVB 2024</h1>
        <p class="mb-4 text-gray-600">
            This chord diagram visualizes the match results between teams in the first half of the 2024 BWC WVB season.
        </p>
        <div class="bg-white p-4 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">Instructions:</h2>
            <ul class="list-disc pl-5 text-gray-700">
                <li>Click on a team's arc or legend item to highlight its connections.</li>
                <li>Click/Hover on arcs to see match detail.</li>
                <li>Use the "Show All" button to reset the diagram.</li>
                <li>Toggle the tooltip and weighted view using the buttons below.</li>
            </ul>
        </div>
        <div class="btn-group">
            <button id="show-all" class="btn">Show All</button>
            <button id="toggle-tooltip" class="btn">Tooltip: On</button>
            <button id="toggle-weighted" class="btn">Toggle Weighted: Off</button>
             <button id="toggle-winner-color" class="btn">Use Winner Color: On</button>
        </div>
        <div id="my_dataviz" class=""></div>
        <div id="tooltip" class="tooltip"></div>
        <div id="legend" class="legend"></div>
        <div class="mt-4 text-sm text-gray-600">
            <strong>Weight Explanation:</strong>0 set won = 1pt, 1 set won = 3pt, 2 sets won = 5 pts, 3 sets won = 10 pts. 1 bonus point for sweep.
        </div>
    </div>
    <script>
        // Create the SVG area
        const svg = d3.select("#my_dataviz")
            .append("svg")
            .attr("width", 440)
            .attr("height", 440)
            .append("g")
            .attr("transform", "translate(220,220)");

        // Input data: unweighted matrix
        const unweightedMatrix =  [[0, 0, 0, 3, 0, 0, 2, 2, 3, 1, 1], [3, 0, 3, 3, 0, 0, 1, 3, 3, 0, 3], [0, 0, 0, 3, 0, 1, 1, 3, 1, 1, 3], [2, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1], [0, 3, 0, 3, 0, 3, 1, 2, 3, 3, 0], [3, 0, 3, 3, 0, 0, 3, 2, 3, 3, 0], [3, 3, 3, 0, 3, 1, 0, 0, 3, 3, 3], [3, 0, 1, 3, 3, 3, 0, 0, 0, 2, 3], [0, 0, 3, 0, 0, 0, 0, 0, 0, 2, 0], [3, 0, 3, 3, 2, 0, 0, 3, 3, 0, 0], [3, 0, 0, 3, 3, 0, 1, 1, 3, 0, 0]];

        // Weighted matrix
        const weightedMatrix = [[0, 1, 0, 10, 0, 1, 5, 5, 11, 3, 3], [11, 0, 11, 11, 1, 0, 3, 11, 11, 0, 11], [0, 1, 0, 10, 0, 3, 3, 10, 3, 3, 11], [5, 1, 3, 0, 1, 1, 0, 3, 0, 3, 3], [0, 11, 0, 11, 0, 11, 3, 5, 11, 10, 1], [11, 0, 10, 11, 1, 0, 10, 5, 11, 11, 0], [10, 10, 10, 0, 10, 3, 0, 0, 11, 11, 10], [10, 1, 3, 10, 10, 10, 0, 0, 0, 5, 10], [1, 1, 10, 0, 1, 1, 1, 0, 0, 5, 1], [10, 0, 10, 10, 5, 1, 1, 10, 10, 0, 0], [10, 1, 1, 10, 11, 0, 3, 3, 11, 0, 0]]



        const teams = ['CSUN', 'Cal Poly', 'Cal State Bakersfield', 'Cal State Fullerton', "Hawai'i", 'Long Beach State', 'UC Davis', 'UC Irvine', 'UC Riverside', 'UC San Diego', 'UC Santa Barbara'];
        const colors = ['#ce1126', '#154734', '#003594', '#ff7900', "#000000", '#ecaa00', '#b3a369', '#0c2340', '#0073d4', '#adb7b9', '#30007f']; // Different colors for each node
        
        
        let currentMatrix = unweightedMatrix; // Start with unweighted matrix
        const res = d3.chord()
            .padAngle(0.05)
            .sortSubgroups(d3.descending)(currentMatrix);

        const tooltip = d3.select("#tooltip");
        let showPathTooltips = true; // Flag to control path tooltips visibility
        let weightedView = false; // Flag to control view type
        let useWinnerColor = true; // Flag for winner color toggle

        function drawChords(filterIndex = null, useWinnerColor = true) {
            // Clear previous drawings except the legend
            svg.selectAll(".arc").remove();
            svg.selectAll(".ribbon").remove();

            // Update the chord diagram based on the current matrix
            const res = d3.chord()
                .padAngle(0.05)
                .sortSubgroups(d3.descending)(currentMatrix);

            // Draw groups (arcs)
            svg
                .datum(res)
                .append("g")
                .selectAll("g")
                .data(d => d.groups)
                .join("g")
                .append("path")
                .attr("d", d3.arc()
                    .innerRadius(200)
                    .outerRadius(210))
                .attr("class", "arc")
                .style("fill", (d, i) => colors[i]) // Apply color based on index
                .on("mouseover", function(event, d) {
                    tooltip.style("display", "block")
                           .html(`<strong>${teams[d.index]}</strong>`)
                           .style("left", (event.pageX + 5) + "px")
                           .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("display", "none");
                })
                .on("click", function(event, d) {
                    drawChords(d.index, useWinnerColor); // Draw only connected to clicked node
                });

            // Draw ribbons (links)
            svg
                .datum(res)
                .append("g")
                .selectAll("path")
                .data(d => {
                    if (filterIndex === null) {
                        return d; // Return all ribbons if no filter
                    }
                    return d.filter(chord => chord.source.index === filterIndex || chord.target.index === filterIndex);
                })
                .join("path")
                .attr("d", d3.ribbon()
                    .radius(200))
                .attr("class", "ribbon")
                .style("fill", d => {
                    if (useWinnerColor) {
                        // Determine the color based on the greater value
                        const sourceValue = currentMatrix[d.source.index][d.target.index];
                        const targetValue = currentMatrix[d.target.index][d.source.index];
                        return sourceValue >= targetValue ? colors[d.source.index] : colors[d.target.index];
                    } else {
                        return "#a2c9d8"; // Default color when winner color is off
                    }
                })
                .on("mouseover", function(event, d) {
                    if (showPathTooltips) {
                        const sourceName = teams[d.source.index];
                        const targetName = teams[d.target.index];
                        const value = unweightedMatrix[d.source.index][d.target.index]; // Always show unweighted value
                        tooltip.style("display", "block")
                               .html(`<strong>${sourceName} ${value} - ${unweightedMatrix[d.target.index][d.source.index]} ${targetName}</strong>`)
                               .style("left", (event.pageX + 5) + "px")
                               .style("top", (event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", function() {
                    tooltip.style("display", "none");
                });
        }

        // Draw the legend only once
        function drawLegend() {
            const legend = d3.select("#legend")
                .selectAll(".legend-item")
                .data(teams)
                .join("div")
                .attr("class", "legend-item")
                .on("click", (event, d) => {
                    const index = teams.indexOf(d);
                    drawChords(index, useWinnerColor); // Draw only connected to the clicked legend item
                });

            legend.append("div")
                .attr("class", "legend-color")
                .style("background-color", (d, i) => colors[i]);

            legend.append("span")
                .text(d => d);
        }

        // Initial draw
        drawChords();
        drawLegend();

        // Button event listener for "Show All"
        document.getElementById("show-all").addEventListener("click", () => drawChords());

        // Button event listener for toggling path tooltips
        document.getElementById("toggle-tooltip").addEventListener("click", () => {
            showPathTooltips = !showPathTooltips; // Toggle the flag
            const button = document.getElementById("toggle-tooltip");
            button.textContent = `Tooltip: ${showPathTooltips ? "On" : "Off"}`; // Update button text
        });

        // Button event listener for toggling weighted view
        document.getElementById("toggle-weighted").addEventListener("click", () => {
            weightedView = !weightedView; // Toggle the flag
            currentMatrix = weightedView ? weightedMatrix : unweightedMatrix; // Switch matrix
            const button = document.getElementById("toggle-weighted");
            button.textContent = `Toggle Weighted: ${weightedView ? "On" : "Off"}`; // Update button text
            drawChords(); // Redraw the chords
        });

        // Button event listener for toggling winner color
        document.getElementById("toggle-winner-color").addEventListener("click", () => {
            useWinnerColor = !useWinnerColor; // Toggle the flag
            const button = document.getElementById("toggle-winner-color");
            button.textContent = `Use Winner Color: ${useWinnerColor ? "On" : "Off"}`; // Update button text
            drawChords(null, useWinnerColor); // Redraw the chords with updated color settings
        });
    </script>
</body>
</html>
